#ifndef _UNICAM_H
#define _UNICAM_H

#include <exec/types.h>
#include <exec/nodes.h>
#include <exec/libraries.h>
#include <exec/execbase.h>
#include <common/compiler.h>
#include <stdint.h>
#include <resources/unicam.h>

#define UNICAM_VERSION  ${PROJECT_VERSION_MAJOR}
#define UNICAM_REVISION ${PROJECT_VERSION_MINOR}
#define UNICAM_PRIORITY 118

#define UNICAM_MODE     0x22
#define UNICAM_WIDTH    720
#define UNICAM_HEIGHT   576
#define UNICAM_BPP      16

struct Size {
    UWORD width;
    UWORD height;
};

struct Point {
    UWORD x;
    UWORD y;
};

struct UnicamBase {
    struct Library      u_Node;
    APTR                u_MailboxBase;
    struct ExecBase *   u_SysBase;
    APTR                u_ROMBase;
    struct ConfigDev *  u_ConfigDev;
    APTR                u_PeriphBase;
    APTR                u_ReceiveBuffer;
    ULONG               u_ReceiveBufferSize;
    struct Size         u_DisplaySize;
    struct Size         u_Size;
    struct Point        u_Offset;
    struct Size         u_FullSize;
    ULONG               u_UnicamDL;
    ULONG               u_UnicamKernel;

    UWORD               u_KernelB;
    UWORD               u_KernelC;
    UWORD               u_Aspect;
    UBYTE               u_Scaler;
    UBYTE               u_Phase;
    UBYTE               u_Integer;
    UBYTE               u_Smooth;
    UBYTE               u_Mode;
    UBYTE               u_BPP;
    BOOL                u_StartOnBoot;
    BOOL                u_IsVC6;
    UBYTE               u_Type;
    UBYTE               u_PixelOrder;
};

#define TYPE_FT     0
#define TYPE_C790   1

#define UNICAM_FUNC_COUNT   17
#define BASE_NEG_SIZE       ((UNICAM_FUNC_COUNT) * 6)
#define BASE_POS_SIZE       (sizeof(struct UnicamBase))

static inline uint64_t LE64(uint64_t x) { return __builtin_bswap64(x); }
static inline uint32_t LE32(uint32_t x) { return __builtin_bswap32(x); }
static inline uint16_t LE16(uint16_t x) { return __builtin_bswap16(x); }

void kprintf(REGARG(const char * msg, "a0"), REGARG(void * args, "a1"));

#define bug(string, ...) \
    do { ULONG args[] = {0, __VA_ARGS__}; kprintf(string, &args[1]); } while(0)

static inline void wr32le(volatile ULONG *addr, ULONG value) {
    *addr = LE32(value);
    asm volatile("nop");
    bug("[unicam] wr32le(%08lx, %08lx)\n", (ULONG)addr, value);
}

static inline ULONG rd32le(volatile ULONG *addr) {
    ULONG val = LE32(*addr);
    asm volatile("nop");
    bug("[unicam] rd32le(%08lx) -> %08lx\n", (ULONG)addr, val);
    return val;
}

void init_c790_ic(struct UnicamBase * UnicamBase);
void unicam_run(ULONG *address , UBYTE lanes, UBYTE datatype, ULONG width , ULONG height , UBYTE bbp, struct UnicamBase * UnicamBase);
void unicam_stop(struct UnicamBase * UnicamBase);
void setup_csiclk(struct UnicamBase * UnicamBase);

void L_UnicamStart(REGARG(ULONG *address, "a0"), REGARG(UBYTE lanes, "d0"), REGARG(UBYTE datatype, "d1"),
                 REGARG(ULONG width, "d2"), REGARG(ULONG height, "d3"), REGARG(UBYTE bpp, "d4"),
                 REGARG(struct UnicamBase * UnicamBase, "a6"));
void L_UnicamStop(REGARG(struct UnicamBase * UnicamBase, "a6"));
APTR L_UnicamGetFramebuffer(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamGetFramebufferSize(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamGetCropSize(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamGetCropOffset(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamGetKernel(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamGetConfig(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamGetSize(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamGetMode(REGARG(struct UnicamBase * UnicamBase, "a6"));
ULONG L_UnicamConstructDL(REGARG(ULONG * dlist, "a0"), REGARG(ULONG offset, "d0"), REGARG(struct UnicamBase * UnicamBase, "a6"));
void L_UnicamSetConfig(REGARG(ULONG cfg, "d0"), REGARG(struct UnicamBase * UnicamBase, "a6"));
void L_UnicamSetCropSize(REGARG(UWORD width, "d0"), REGARG(UWORD height, "d1"), REGARG(struct UnicamBase * UnicamBase, "a6"));
void L_UnicamSetCropOffset(REGARG(ULONG x, "d0"), REGARG(ULONG y, "d1"), REGARG(struct UnicamBase * UnicamBase, "a6"));
void L_UnicamSetKernel(REGARG(UWORD b, "d0"), REGARG(UWORD c, "d1"), REGARG(struct UnicamBase * UnicamBase, "a6"));
UWORD L_UnicamGetAspect(REGARG(struct UnicamBase * UnicamBase, "a6"));
void L_UnicamSetAspect(REGARG(UWORD aspect, "d0"), REGARG(struct UnicamBase * UnicamBase, "a6"));

#endif /* _UNICAM_H */
